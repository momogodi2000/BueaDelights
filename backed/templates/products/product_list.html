{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="text-center mb-12">
        <h1 class="text-4xl font-bold mb-4 text-gradient">Nos Produits</h1>
        <p class="text-lg max-w-2xl mx-auto">Découvrez notre sélection de produits artisanaux préparés avec passion à Buea</p>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Product Filters -->
        <div class="lg:w-1/4">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-4">
                <h3 class="text-xl font-bold mb-4">Filtrer par catégorie</h3>
                <ul class="space-y-2">
                    <li>
                        <a href="?category=" class="block px-4 py-2 rounded hover:bg-gray-100 {% if not selected_category %}bg-green-100 text-green-800{% endif %}">
                            Toutes les catégories
                        </a>
                    </li>
                    {% for category in categories %}
                    <li>
                        <a href="?category={{ category.id }}" class="block px-4 py-2 rounded hover:bg-gray-100 {% if selected_category == category.id %}bg-green-100 text-green-800{% endif %}">
                            {{ category.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>

                <!-- Cart Summary -->
                <div class="mt-8 border-t pt-6">
                    <h3 class="text-xl font-bold mb-4">Votre Panier</h3>
                    {% if cart_items %}
                    <div class="space-y-4 max-h-64 overflow-y-auto">
                        {% for item in cart_items %}
                        <div class="flex justify-between items-center border-b pb-2">
                            <div>
                                <h4 class="font-medium">{{ item.product.name }}</h4>
                                <div class="flex items-center mt-1">
                                    <button class="update-quantity" data-product-id="{{ item.product.id }}" data-action="decrease" 
                                        class="w-6 h-6 flex items-center justify-center bg-gray-200 rounded">
                                        -
                                    </button>
                                    <span class="quantity mx-2">{{ item.quantity }}</span>
                                    <button class="update-quantity" data-product-id="{{ item.product.id }}" data-action="increase" 
                                        class="w-6 h-6 flex items-center justify-center bg-gray-200 rounded">
                                        +
                                    </button>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-medium">{{ item.total }} XAF</span>
                                <button class="remove-from-cart block mt-1 text-red-500 text-sm" data-product-id="{{ item.product.id }}">
                                    Supprimer
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-4">
                        <div class="flex justify-between font-bold">
                            <span>Sous-total:</span>
                            <span>{{ cart_total }} XAF</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Livraison:</span>
                            <span>{{ delivery_fee }} XAF</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold mt-2">
                            <span>Total:</span>
                            <span>{{ cart_total|add:delivery_fee }} XAF</span>
                        </div>
                    </div>
                    <div class="mt-4 space-y-2">
                        <a href="{% url 'checkout' %}" class="block w-full bg-green-600 hover:bg-green-700 text-white text-center py-2 px-4 rounded-lg">
                            Commander
                        </a>
                        <button id="clear-cart" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg">
                            Vider le panier
                        </button>
                    </div>
                    {% else %}
                    <p class="text-gray-500">Votre panier est vide</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Product Grid -->
        <div class="lg:w-3/4">
            {% if products %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for product in products %}
                <div class="bg-white rounded-xl overflow-hidden shadow-lg transform transition duration-300 hover:-translate-y-1 hover:shadow-xl">
                    <div class="relative">
                        <img src="{{ image.url }}" alt="{{ product.name }}" class="w-full h-48 object-cover">
                        {% if product.is_featured %}
                        <div class="absolute top-2 right-2 bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded">
                            Populaire
                        </div>
                        {% endif %}
                    </div>
                    <div class="p-4">
                        <h3 class="text-xl font-bold mb-2">{{ product.name }}</h3>
                        <p class="text-gray-600 mb-4">{{ product.description|truncatechars:100 }}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold text-green-600">{{ product.price }} XAF</span>
                            {% if product.stock_quantity > 0 %}
                            <button class="add-to-cart bg-green-600 hover:bg-green-700 text-white rounded-full p-2" 
                                data-product-id="{{ product.id }}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            {% else %}
                            <span class="text-sm text-red-500">En rupture</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-white rounded-lg shadow-md p-8 text-center">
                <p class="text-gray-500">Aucun produit disponible dans cette catégorie.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Cart Modal -->
<div id="cart-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-2xl leading-6 font-bold text-green-600 mb-4">Votre Panier</h3>
                        <div id="cart-modal-content" class="mt-2">
                            <!-- Cart content will be loaded here via AJAX -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="closeCartModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Continuer mes achats
                </button>
                <a href="{% url 'checkout' %}" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Commander
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize cart timeout (15 minutes)
    let cartTimeout;
    const CART_TIMEOUT = 15 * 60 * 1000; // 15 minutes in milliseconds
    
    function resetCartTimeout() {
        clearTimeout(cartTimeout);
        cartTimeout = setTimeout(() => {
            // Clear cart after timeout
            fetch("{% url 'clear_cart' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }, CART_TIMEOUT);
    }
    
    // Reset timeout on page load and any interaction
    document.addEventListener('DOMContentLoaded', resetCartTimeout);
    document.addEventListener('click', resetCartTimeout);
    document.addEventListener('keypress', resetCartTimeout);
    
    // Add to cart functionality
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            
            fetch("{% url 'add_to_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `product_id=${productId}&quantity=1`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update cart count in navbar
                    document.querySelectorAll('.cart-count').forEach(el => {
                        el.textContent = data.cart_count;
                    });
                    
                    // Show success message
                    const toast = document.createElement('div');
                    toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg';
                    toast.textContent = 'Produit ajouté au panier';
                    document.body.appendChild(toast);
                    
                    setTimeout(() => {
                        toast.remove();
                    }, 3000);
                    
                    // Reload the page to update cart summary
                    location.reload();
                }
            });
        });
    });
    
    // Update quantity
    document.querySelectorAll('.update-quantity').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            const action = this.getAttribute('data-action');
            
            fetch("{% url 'update_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `product_id=${productId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        });
    });
    
    // Remove from cart
    document.querySelectorAll('.remove-from-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            
            fetch("{% url 'remove_from_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: `product_id=${productId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        });
    });
    
    // Clear cart
    document.getElementById('clear-cart')?.addEventListener('click', function() {
        if (confirm('Êtes-vous sûr de vouloir vider votre panier?')) {
            fetch("{% url 'clear_cart' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
        }
    });
    
    // Cart modal functions
    function openCartModal() {
        document.getElementById('cart-modal').classList.remove('hidden');
    }
    
    function closeCartModal() {
        document.getElementById('cart-modal').classList.add('hidden');
    }
</script>
{% endblock %}